{% extends "base.html" %}

{% block title %}Профиль пользователя - Электронный дневник{% endblock %}

{% block content %}
<div class="container">
    <div class="page-header">
        <h1><i class="fas fa-user"></i> Профиль пользователя</h1>
    </div>
    
    <div class="profile-container">
        <div class="profile-card">
            <div class="profile-header">
                <div class="profile-avatar">
                    <i class="fas fa-user-circle"></i>
                </div>
                <div class="profile-info">
                    <h2>{{ user.get_full_name() }}</h2>
                    <p class="profile-role">
                        <i class="fas fa-{% if user.is_student() %}graduation-cap{% elif user.is_parent() %}users{% elif user.is_teacher() %}chalkboard-teacher{% else %}crown{% endif %}"></i>
                        {{ user.role.value|title }}
                    </p>
                    <p class="profile-username">@{{ user.username }}</p>
                </div>
            </div>
            
            <div class="profile-details">
                <div class="detail-item">
                    <label>Email:</label>
                    <span>{{ user.email }}</span>
                </div>
                <div class="detail-item">
                    <label>Дата регистрации:</label>
                    <span>{{ user.created_at.strftime('%d.%m.%Y') }}</span>
                </div>
                <div class="detail-item">
                    <label>Статус:</label>
                    <span class="status status-{% if user.is_active %}active{% else %}inactive{% endif %}">
                        {% if user.is_active %}Активен{% else %}Заблокирован{% endif %}
                    </span>
                </div>
                <!-- Telegram block -->
                <div class="detail-item">
                    <label>Telegram:</label>
                    <div>
                        {% if user.telegram_id %}
                            {% if user.telegram_username %}
                                <span>Привязан: @{{ user.telegram_username }}</span>
                            {% else %}
                                <span>Привязан (id): {{ user.telegram_id }}</span>
                            {% endif %}
                            <button id="btn-unbind-telegram" class="btn btn-secondary" style="margin-left: 1rem;">Открепить</button>
                        {% else %}
                            <span>Не привязан</span>
                            <button id="btn-bind-telegram" class="btn btn-primary" style="margin-left: 1rem;">Привязать Telegram</button>
                        {% endif %}
                    </div>
                </div>
                <!-- /Telegram block -->
            </div>
            
            <div class="profile-actions">
                <a href="{{ url_for('auth.change_password') }}" class="btn btn-secondary">
                    <i class="fas fa-key"></i> Изменить пароль
                </a>
                {% if user.is_parent() or user.is_teacher() %}
                    <a href="{{ url_for('auth.setup_relationships') }}" class="btn btn-info">
                        <i class="fas fa-link"></i> Настроить связи
                    </a>
                {% endif %}
            </div>
        </div>
        
        {% if user.is_student() and user.student_profile %}
            <div class="profile-card">
                <h3><i class="fas fa-graduation-cap"></i> Информация о студенте</h3>
                <div class="profile-details">
                    <div class="detail-item">
                        <label>Класс:</label>
                        <span>{{ user.student_profile.class_name }}</span>
                    </div>
                    <div class="detail-item">
                        <label>Дата добавления:</label>
                        <span>{{ user.student_profile.created_at.strftime('%d.%m.%Y') }}</span>
                    </div>
                </div>
                <div class="profile-actions">
                    <a href="{{ url_for('students.student_diary', student_id=user.student_profile.id) }}" class="btn btn-primary">
                        <i class="fas fa-book-open"></i> Открыть дневник
                    </a>
                </div>
            </div>
        {% endif %}
        
        {% if user.is_parent() and user.parent_children %}
            <div class="profile-card">
                <h3><i class="fas fa-users"></i> Мои дети</h3>
                <div class="children-list">
                    {% for relationship in user.parent_children %}
                        <div class="child-item">
                            <div class="child-info">
                                <h4>{{ relationship.child.name }}</h4>
                                <p>{{ relationship.child.class_name }}</p>
                            </div>
                            <div class="child-actions">
                                <a href="{{ url_for('students.student_diary', student_id=relationship.child.id) }}" class="btn btn-sm btn-primary">
                                    <i class="fas fa-book-open"></i> Дневник
                                </a>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>
        {% endif %}
        
        {% if user.is_teacher() and user.teacher_subjects %}
            <div class="profile-card">
                <h3><i class="fas fa-chalkboard-teacher"></i> Мои предметы</h3>
                <div class="subjects-list">
                    {% for ts in user.teacher_subjects %}
                        <div class="subject-item">
                            <div class="subject-info">
                                <h4>{{ ts.subject.name }}</h4>
                                <p>{% if ts.is_primary %}Основной учитель{% else %}Дополнительный учитель{% endif %}</p>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>
        {% endif %}
    </div>
</div>

<div id="telegram-modal" class="modal" style="display:none;">
  <div class="modal-content" style="max-width:820px; display:flex; gap:1rem; align-items:flex-start;">
    <div style="flex:1;">
      <h3>Привязать Telegram</h3>
      <p>Откройте нашего бота и нажмите <code>/start</code>. Бот пришлёт вам уникальный токен — скопируйте его и вставьте в поле снизу.</p>

      <div class="form-group">
        <label for="telegram_token">Токен</label>
        <input id="telegram_token" class="form-control" placeholder="Вставьте токен сюда" />
        <div id="token-error" class="error" style="display:none;"></div>
      </div>

      <div class="form-actions" style="justify-content:flex-end; margin-top:1rem;">
        <button id="confirm-token" class="btn btn-primary">Подтвердить</button>
        <button id="close-telegram-modal" class="btn btn-secondary" style="margin-left:0.5rem;">Отмена</button>
      </div>

      <div id="telegram-msg" style="margin-top:1rem;"></div>
    </div>

    <div style="width:240px; text-align:center;">
      <img src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=https://t.me/CUDnevnikB_bot" alt="QR bot" style="border-radius:8px;"/>
      <div style="margin-top:0.75rem;">
        <a href="https://t.me/CUDnevnikB_bot" target="_blank" class="btn btn-secondary" style="display:inline-block;">Открыть бот</a>
      </div>
    </div>
  </div>
</div>

<style>
.modal { position: fixed; inset: 0; background: rgba(0,0,0,0.4); display:flex; align-items:center; justify-content:center; z-index:1000; }
.modal-content { background: white; padding: 1.25rem; border-radius: 10px; box-shadow: 0 8px 30px rgba(0,0,0,0.15); }
</style>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const modal = document.getElementById('telegram-modal');
    const btnBind = document.getElementById('btn-bind-telegram');
    const btnUnbind = document.getElementById('btn-unbind-telegram');
    const closeBtn = document.getElementById('close-telegram-modal');
    const confirmBtn = document.getElementById('confirm-token');
    const tokenInput = document.getElementById('telegram_token');
    const msgBox = document.getElementById('telegram-msg');
    const errorBox = document.getElementById('token-error');

    function openModal(){ modal.style.display = 'flex'; msgBox.innerText=''; errorBox.style.display='none'; tokenInput.value=''; tokenInput.focus(); }
    function closeModal(){ modal.style.display = 'none'; }

    if (btnBind) btnBind.addEventListener('click', openModal);
    if (closeBtn) closeBtn.addEventListener('click', closeModal);

    // validation: token must be alnum + - _ and length >=8
    function validToken(t){
        if(!t) return {ok:false,msg:'Введите токен'};
        if(t.length < 8) return {ok:false,msg:'Токен слишком короткий'};
        if(!/^[A-Za-z0-9_-]{8,128}$/.test(t)) return {ok:false,msg:'Токен содержит недопустимые символы'};
        return {ok:true};
    }

    confirmBtn.addEventListener('click', async () => {
        const token = tokenInput.value.trim();
        errorBox.style.display = 'none';
        const v = validToken(token);
        if(!v.ok){
            errorBox.innerText = v.msg; errorBox.style.display='block'; return;
        }
        // send
        msgBox.innerText = 'Подтверждаем...';
        try {
            const resp = await fetch('{{ url_for("auth.profile_telegram_verify") }}', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ token })
            });
            const data = await resp.json();
            if (resp.ok && data.ok) {
                // clear input
                tokenInput.value = '';
                // reload to show flash and updated profile
                window.location.reload();
            } else {
                errorBox.innerText = data.message || 'Ошибка верификации';
                errorBox.style.display = 'block';
                tokenInput.value = '';
            }
        } catch (e) {
            errorBox.innerText = 'Ошибка сети';
            errorBox.style.display = 'block';
        } finally {
            msgBox.innerText = '';
        }
    });

    if (btnUnbind) {
        btnUnbind.addEventListener('click', async () => {
            if (!confirm('Открепить Telegram от аккаунта?')) return;
            try {
                const resp = await fetch('{{ url_for("auth.profile_telegram_unbind") }}', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({})
                });
                window.location.reload();
            } catch (e) {
                alert('Ошибка открепления');
            }
        });
    }
});
</script>

{% endblock %}

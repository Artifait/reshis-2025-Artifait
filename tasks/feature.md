# 2-факторная авторизация через Telegram

## Контекст

Если пользователь входит с IP, отличающегося от последнего успешного входа, система отправляет в Telegram пользователю запрос на подтверждение входа. Это уменьшит риск несанкционированного доступа при компрометации пароля.

## Функциональные требования

- При успешной проверке логина/пароля проверяется текущий IP (`request.remote_addr`).
- Если IP отличается от `user.last_login_ip` и у пользователя указан `telegram_id`, создаётся запись `login_confirmation` со статусом `pending` и токеном.
- Отправляется Telegram-уведомление с текстом и двумя inline-кнопками: «Да» (callback `confirm_login:<token>`) и «Нет» (callback `deny_login:<token>`).
- Браузер пользователя при этом показывает страницу «Подтвердите вход через Telegram» с индикатором статуса (JS polling либо кнопка «Обновить»).
- При подтверждении (нажатие «Да» в Telegram) запись `login_confirmation` переводится в `confirmed` и браузер пользователя может завершить вход: создаётся сессия (вызывается `login_user`) и `user.last_login_ip` обновляется на новый IP.
- При отказе (нажатие «Нет») запись переводится в `denied` и вход не разрешается — в браузер показывается ошибка об отмене, и рекомендуется сменить пароль.
- Таймаут подтверждения: после N минут (например, 5) запись помечается `expired` и вход блокируется.

## UI-требования

- Страница входа: если нужен подтверждающий шаг, после успешного ввода пароля показывается страница `auth/wait_confirmation.html` с кратким текстом и индикатором статуса и кнопкой «Отменить»/«Попробовать снова».
- Сообщение в Telegram должно содержать IP и два понятных действия, например:

```
⚠️ Artifait, подтвердите авторизацию с устройства: 94.125.100.108

❗️ Если это вы — нажмите "Да", иначе нажмите "Нет" и срочно смените пароль!
```

Кнопки: Да / Нет (callback с токеном).

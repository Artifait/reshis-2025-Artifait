# Привязка Telegram ID к аккаунту

## Контекст

Чтобы пользователь мог получать 2FA-уведомления при входе с нового IP, он должен привязать свой Telegram‑аккаунт. Чтобы исключить ошибки (например, ввод чужого Telegram ID, что может привести к потери доступа к дневнику у пользователя), привязка проводится через подтверждение одноразовым кодом, отправленным ботом.

## Функциональные требования

- На странице редактирования профиля пользователь видит блок «Telegram» с кнопками **Привязать / Изменить Telegram**.
- При нажатии открывается модальное окно с:
  - именем бота `@CUDnevnikB_bot`;
  - QR‑кодом со ссылкой на бота;
  - кнопкой «Открыть бота»;
  - кнопкой «Отправить код проверки».
- После нажатия кнопки «Отправить код проверки» создаётся запись `telegram_bind_request` со статусом `pending` и 4‑значным кодом.
- Бот отправляет пользователю сообщение: «Ваш код подтверждения: XXXX».
- Пользователь вводит код в форме в модальном окне и подтверждает.
- Если код верный — Telegram ID записывается в профиль пользователя.
- Если код неверный — пользователь получает ошибку и может запросить новый код.
- Ограничение: не более 5 неверных попыток, затем блокировка отправки кодов на 1 час.

## UI‑требования

- Модальное окно с полями:
  - QR‑код
  - ссылка на бота
  - поле ввода кода (4 цифры)
  - кнопки: «Отправить код», «Подтвердить», «Отмена»
- В случае успеха показывается короткое сообщение «Telegram успешно привязан».
- При ошибке неверного кода — сообщение об ошибке под полем.

## Технические детали

- Новая таблица `telegram_bind_requests`:
  - `id`, `user_id`, `code`, `status`, `created_at`, `expires_at`, `attempts`.
- Генерация кода: случайные 4 цифры, срок действия 10 минут.
- При подтверждении `telegram_id` сохраняется в таблицу `users`.
- После подтверждения все старые `pending` запросы автоматически помечаются как `cancelled`.
